<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SC2 2:2 REALTIME PICK</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <style>
        :root { 
            --blue-team: #339af0; --red-team: #ff6b6b; 
            --success: #51cf66; --dark: #121212; --card-bg: #1e1e1e; 
        }
        body { font-family: 'Pretendard', sans-serif; background-color: var(--dark); color: #e0e0e0; margin: 0; padding: 0; display: flex; flex-direction: column; align-items: center; min-height: 100vh; -webkit-tap-highlight-color: transparent; }
        
        /* 로비 UI */
        #lobby { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; width: 100%; min-height: 100vh; box-sizing: border-box; }
        .entrance-grid { display: grid; grid-template-columns: 1fr; gap: 15px; width: 100%; max-width: 400px; margin-top: 20px; }
        
        /* 팀별 버튼 스타일 */
        .entrance-card { padding: 20px; border-radius: 12px; text-align: center; cursor: pointer; transition: 0.2s; border: 2px solid transparent; }
        .entrance-card h3 { margin: 0 0 5px 0; font-size: 1.2rem; }
        .entrance-card span { font-size: 0.85rem; opacity: 0.8; }
        
        /* 블루팀 스타일 */
        .card-blue.selector { background: var(--blue-team); color: white; }
        .card-blue.viewer { border-color: var(--blue-team); color: var(--blue-team); }
        /* 레드팀 스타일 */
        .card-red.selector { background: var(--red-team); color: white; }
        .card-red.viewer { border-color: var(--red-team); color: var(--red-team); }
        
        .entrance-card.locked { opacity: 0.3; filter: grayscale(1); pointer-events: none; background: #333 !important; border-color: #444 !important; color: #777 !important; }
        
        .btn-force-reset { margin-top: 40px; background: none; border: 1px solid #444; color: #777; padding: 10px 20px; border-radius: 8px; font-size: 0.8rem; cursor: pointer; }

        /* 메인 게임 UI */
        .container { width: 100%; max-width: 500px; display: none; padding: 15px; box-sizing: border-box; }
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .nav-btns { display: flex; gap: 10px; }
        .btn-home { background: #333; color: #ccc; border: none; padding: 6px 12px; border-radius: 6px; font-size: 0.8rem; cursor: pointer; }

        .status-container { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        .team-card { padding: 12px; border-radius: 10px; background: var(--card-bg); text-align: center; border-bottom: 3px solid #444; }
        
        .race-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 15px; }
        .race-item { padding: 18px 10px; background: #2a2a2a; border: 2px solid transparent; border-radius: 8px; text-align: center; font-size: 0.85rem; }
        .race-item.selected { border-color: var(--success); background: #1b3d21; font-weight: bold; }
        .race-item.used { opacity: 0.2; pointer-events: none; text-decoration: line-through; }
        
        .btn-confirm { background: var(--success); color: white; width: 100%; padding: 16px; border-radius: 10px; border: none; font-size: 1.1rem; font-weight: bold; }
        .btn-confirm:disabled { background: #444; opacity: 0.6; }

        .history-section { background: #1a1a1a; border-radius: 10px; padding: 12px; margin-top: 20px; font-size: 0.85rem; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        td, th { padding: 10px 8px; text-align: center; border-bottom: 1px solid #333; }
        .latest-row { background-color: rgba(255, 255, 255, 0.07); font-weight: bold; }
        
        .rem-list { display: flex; flex-wrap: wrap; gap: 4px; margin-top: 8px; }
        .rem-item { padding: 3px 6px; font-size: 0.7rem; background: #252525; border-radius: 4px; color: #777; }
    </style>
</head>
<body>

<div id="lobby">
    <h2 style="margin-bottom: 5px;">스타2 2:2 실시간 밴픽</h2>
    <div class="entrance-grid">
        <div class="entrance-card card-blue selector" id="card-A-Selector" onclick="join('Blue', 'Selector')"><h3>블루팀 선택자</h3><span id="tag-A-Selector">접속 가능</span></div>
        <div class="entrance-card card-blue viewer" id="card-A-Viewer" onclick="join('Blue', 'Viewer')"><h3>블루팀 관전자</h3><span id="tag-A-Viewer">접속 가능</span></div>
        
        <div class="entrance-card card-red selector" id="card-B-Selector" onclick="join('Red', 'Selector')"><h3>레드팀 선택자</h3><span id="tag-B-Selector">접속 가능</span></div>
        <div class="entrance-card card-red viewer" id="card-B-Viewer" onclick="join('Red', 'Viewer')"><h3>레드팀 관전자</h3><span id="tag-B-Viewer">접속 가능</span></div>
    </div>
    <button class="btn-force-reset" onclick="handleReset(true)">⚠️ 모든 접속 및 데이터 강제 초기화</button>
</div>

<div class="container" id="main-container">
    <header>
        <button class="btn-home" onclick="goHome()">홈화면</button>
        <h2 id="round-title" style="font-size: 1.1rem;">RD 1 / 10</h2>
        <div id="user-tag" style="font-size: 0.8rem; padding: 4px 8px; border-radius: 5px; background: #252525;"></div>
    </header>
    
    <div class="status-container">
        <div class="team-card" id="ui-card-my"><div class="team-label" style="font-size:0.7rem; color:#888;">우리 팀</div><div id="ui-pick-my" class="pick-value">-</div></div>
        <div class="team-card" id="ui-card-opp"><div class="team-label" style="font-size:0.7rem; color:#888;">상대 팀</div><div id="ui-pick-opp" class="pick-value">대기 중</div></div>
    </div>

    <div class="race-grid" id="main-race-grid"></div>
    <button id="btn-confirm" class="btn-confirm" disabled onclick="confirmSelection()">선택 확정</button>

    <div class="history-section">
        <strong>상대 남은 조합</strong><div id="opp-rem-list" class="rem-list"></div>
        <strong style="display:block; margin-top:20px;">History</strong>
        <table style="width:100%; margin-top:10px;"><thead><tr><th>RD</th><th style="color:var(--blue-team)">Blue</th><th style="color:var(--red-team)">Red</th></tr></thead><tbody id="history-body"></tbody></table>
    </div>
    <button onclick="handleReset(false)" style="margin-top:25px; background:none; border:none; color:#555; text-decoration:underline; font-size:0.75rem; width:100%;">데이터만 리셋</button>
</div>

<script>
    const DATABASE_URL = "https://scpick-d320f-default-rtdb.asia-southeast1.firebasedatabase.app/";
    firebase.initializeApp({ databaseURL: DATABASE_URL });
    const db = firebase.database();

    const RACES = [
        { id: 1, label: "저그 + 저그" }, { id: 2, label: "저그 + 토스" },
        { id: 3, label: "저그 + 테란" }, { id: 4, label: "저그 + 랜덤" },
        { id: 5, label: "토스 + 토스" }, { id: 6, label: "토스 + 테란" },
        { id: 7, label: "토스 + 랜덤" }, { id: 8, label: "테란 + 테란" },
        { id: 9, label: "테란 + 랜덤" }, { id: 10, label: "랜덤 + 랜덤" }
    ];

    let myTeam, myRole, myId = Math.random().toString(36).substr(2, 9);
    let gameState = { round: 1, aUsed: [], bUsed: [], aPick: null, bPick: null, aDone: false, bDone: false, history: [] };

    db.ref('presence').on('value', snap => {
        const pres = snap.val() || {};
        // 내부 키값은 기존 로직 유지(A, B)
        const mapping = {'A-Selector': 'A-Selector', 'B-Selector': 'B-Selector', 'A-Viewer': 'A-Viewer', 'B-Viewer': 'B-Viewer'};
        Object.keys(mapping).forEach(key => {
            const card = document.getElementById('card-' + key);
            const tag = document.getElementById('tag-' + key);
            if (pres[key]) { card.classList.add('locked'); tag.innerText = '점유 중'; }
            else { card.classList.remove('locked'); tag.innerText = '접속 가능'; }
        });
    });

    db.ref('gameState').on('value', snap => { if (snap.exists()) { gameState = snap.val(); updateUI(); } });

    function join(teamColor, role) {
        myTeam = (teamColor === 'Blue') ? 'A' : 'B';
        myRole = role;
        const key = `${myTeam}-${role}`;
        db.ref('presence/' + key).set(myId);
        db.ref('presence/' + key).onDisconnect().remove();
        document.getElementById('lobby').style.display = 'none';
        document.getElementById('main-container').style.display = 'block';
        document.getElementById('user-tag').innerText = `${teamColor}팀 ${role}`;
        document.getElementById('user-tag').style.color = (teamColor === 'Blue') ? 'var(--blue-team)' : 'var(--red-team)';
        renderGrids();
    }

    function goHome() {
        if(confirm("로비로 이동하시겠습니까? (현재 팀 접속이 해제됩니다)")) {
            const key = `${myTeam}-${myRole}`;
            db.ref('presence/' + key).remove();
            location.reload();
        }
    }

    function renderGrids() {
        const grid = document.getElementById('main-race-grid'); grid.innerHTML = '';
        RACES.forEach(r => {
            const d = document.createElement('div'); d.className = 'race-item'; d.id = `race-${r.id}`; d.innerText = r.label;
            d.onclick = () => {
                if (myRole !== 'Selector') return;
                const used = myTeam === 'A' ? (gameState.aUsed || []) : (gameState.bUsed || []);
                const done = myTeam === 'A' ? gameState.aDone : gameState.bDone;
                if (!used.includes(r.id) && !done && gameState.round <= 10) {
                    if (myTeam === 'A') gameState.aPick = r; else gameState.bPick = r;
                    db.ref('gameState').set(gameState);
                }
            };
            grid.appendChild(d);
        });
        const remList = document.getElementById('opp-rem-list'); remList.innerHTML = '';
        RACES.forEach(r => {
            const s = document.createElement('span'); s.className = 'rem-item'; s.id = `rem-${r.id}`; s.innerText = r.label; remList.appendChild(s);
        });
    }

    function confirmSelection() {
        if (myTeam === 'A') gameState.aDone = true; else gameState.bDone = true;
        if (gameState.aDone && gameState.bDone) {
            if (!gameState.history) gameState.history = [];
            if (!gameState.aUsed) gameState.aUsed = [];
            if (!gameState.bUsed) gameState.bUsed = [];
            gameState.history.push({ r: gameState.round, a: gameState.aPick, b: gameState.bPick });
            gameState.aUsed.push(gameState.aPick.id);
            gameState.bUsed.push(gameState.bPick.id);
            gameState.round++;
            gameState.aDone = false; gameState.bDone = false;
            gameState.aPick = null; gameState.bPick = null;
        }
        db.ref('gameState').set(gameState);
    }

    function handleReset(isForce) {
        if (confirm(isForce ? "시스템을 강제 초기화할까요?" : "데이터를 초기화할까요?")) {
            db.ref('gameState').set({ round: 1, aUsed: [], bUsed: [], aPick: null, bPick: null, aDone: false, bDone: false, history: [] });
            if (isForce) db.ref('presence').remove().then(() => { location.reload(); });
        }
    }

    function updateUI() {
        document.getElementById('round-title').innerText = gameState.round > 10 ? "종료" : `RD ${gameState.round} / 10`;
        const myDone = myTeam === 'A' ? gameState.aDone : gameState.bDone;
        const myPick = myTeam === 'A' ? gameState.aPick : gameState.bPick;
        const oppDone = myTeam === 'A' ? gameState.bDone : gameState.aDone;
        document.getElementById('ui-pick-my').innerText = myPick ? myPick.label : "-";
        document.getElementById('ui-pick-opp').innerText = oppDone ? "준비완료" : "선택 중";
        
        const myUsed = myTeam === 'A' ? (gameState.aUsed || []) : (gameState.bUsed || []);
        const oppUsed = myTeam === 'A' ? (gameState.bUsed || []) : (gameState.aUsed || []);

        RACES.forEach(r => {
            const el = document.getElementById(`race-${r.id}`);
            if (el) {
                el.className = 'race-item';
                if (myUsed.includes(r.id)) el.classList.add('used');
                if (myPick && myPick.id === r.id) el.classList.add('selected');
            }
            const rel = document.getElementById(`rem-${r.id}`);
            if (rel) rel.className = oppUsed.includes(r.id) ? 'rem-item used' : 'rem-item';
        });

        document.getElementById('btn-confirm').disabled = (myRole !== 'Selector' || !myPick || myDone || gameState.round > 10);
        
        const tbody = document.getElementById('history-body'); tbody.innerHTML = '';
        if (gameState.history) {
            const sortedHistory = gameState.history.slice().reverse();
            sortedHistory.forEach((h, index) => {
                const rowClass = index === 0 ? 'class="latest-row"' : '';
                tbody.innerHTML += `<tr ${rowClass}><td>RD ${h.r}</td><td style="color:var(--blue-team)">${h.a.label}</td><td style="color:var(--red-team)">${h.b.label}</td></tr>`;
            });
        }
    }
</script>
</body>
</html>
