<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SC2 2:2 PICK DASHBOARD</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <style>
        @import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css');

        :root { 
            --bg-color: #0f0f0f;
            --blue-main: #007BFF;
            --blue-soft: rgba(0, 123, 255, 0.1);
            --red-main: #FF4B4B;
            --red-soft: rgba(255, 75, 75, 0.1);
            --success: #2ecc71;
            --card-bg: #1a1a1a;
            --text-main: #ffffff;
            --text-dim: #a0a0a0;
        }

        body { 
            font-family: 'Pretendard', sans-serif; 
            background-color: var(--bg-color); 
            color: var(--text-main); 
            margin: 0; padding: 0; 
            display: flex; flex-direction: column; align-items: center; 
            min-height: 100vh; -webkit-tap-highlight-color: transparent;
        }

        /* --- LOBBY DESIGN --- */
        #lobby { 
            display: flex; flex-direction: column; align-items: center; justify-content: center; 
            width: 100%; max-width: 800px; min-height: 100vh; padding: 20px; box-sizing: border-box;
        }

        .lobby-header { text-align: center; margin-bottom: 40px; }
        .lobby-header h1 { font-size: 1.8rem; letter-spacing: -0.5px; margin-bottom: 10px; }
        .lobby-header p { color: var(--text-dim); font-size: 0.9rem; }

        .dashboard-grid { 
            display: grid; grid-template-columns: 1fr 1fr; gap: 20px; width: 100%; 
        }

        @media (max-width: 600px) {
            .dashboard-grid { grid-template-columns: 1fr; }
        }

        .team-section { 
            background: var(--card-bg); border-radius: 20px; padding: 24px; 
            display: flex; flex-direction: column; gap: 16px; border: 1px solid #2a2a2a;
        }

        .team-title { font-size: 1.1rem; font-weight: 700; margin-bottom: 8px; display: flex; align-items: center; gap: 8px; }
        .blue-title { color: var(--blue-main); }
        .red-title { color: var(--red-main); }

        .role-card { 
            position: relative; border-radius: 12px; padding: 20px; cursor: pointer; 
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); border: 1px solid transparent;
        }

        .role-card.selector { background: #252525; border: 1px solid #333; }
        .role-card.selector:hover { transform: translateY(-2px); border-color: #444; }

        .blue-active .role-card.selector { background: var(--blue-main); }
        .red-active .role-card.selector { background: var(--red-main); }

        .role-card.viewer { background: transparent; border: 1px dashed #333; padding: 15px; }
        .blue-active .role-card.viewer { border-color: var(--blue-main); color: var(--blue-main); }
        .red-active .role-card.viewer { border-color: var(--red-main); color: var(--red-main); }

        .role-name { font-weight: 600; font-size: 1rem; margin-bottom: 4px; display: block; }
        
        .status-badge { font-size: 0.75rem; display: flex; align-items: center; gap: 5px; opacity: 0.8; }
        .dot { width: 6px; height: 6px; background-color: var(--success); border-radius: 50%; display: inline-block; box-shadow: 0 0 8px var(--success); animation: blink 1.5s infinite; }
        
        @keyframes blink { 0% { opacity: 0.4; } 50% { opacity: 1; } 100% { opacity: 0.4; } }

        .locked { opacity: 0.2 !important; filter: grayscale(1); pointer-events: none; }

        .btn-force-reset { margin-top: 60px; background: none; border: none; color: #555; font-size: 0.75rem; cursor: pointer; display: flex; align-items: center; gap: 5px; }

        /* --- GAME UI --- */
        .container { width: 100%; max-width: 500px; display: none; padding: 15px; box-sizing: border-box; }
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .btn-home { background: #252525; color: var(--text-dim); border: 1px solid #333; padding: 8px 16px; border-radius: 8px; font-size: 0.8rem; cursor: pointer; }
        
        .status-container { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 20px; }
        .team-card-ingame { padding: 15px; border-radius: 12px; background: var(--card-bg); text-align: center; border-bottom: 4px solid #333; }
        
        .race-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .race-item { padding: 20px 10px; background: #222; border-radius: 10px; text-align: center; border: 2px solid transparent; cursor: pointer; transition: 0.2s; font-size: 0.9rem; }
        .race-item.selected { border-color: var(--success); background: rgba(46, 204, 113, 0.1); font-weight: bold; }
        .race-item.used { opacity: 0.15; pointer-events: none; text-decoration: line-through; }
        
        .btn-confirm { background: var(--success); color: white; width: 100%; padding: 18px; border-radius: 12px; border: none; font-size: 1.1rem; font-weight: 700; margin-top: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.4); }
        .btn-confirm:disabled { background: #333; box-shadow: none; color: #666; }
        .result-panel { margin-top: 14px; background: #161616; border: 1px solid #2a2a2a; border-radius: 12px; padding: 14px; }
        .result-title { font-size: 0.9rem; font-weight: 700; }
        .result-hint { font-size: 0.78rem; color: var(--text-dim); margin-top: 6px; }
        .result-actions { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 12px; }
        .btn-result { border: none; border-radius: 10px; padding: 12px 8px; color: #fff; font-weight: 700; cursor: pointer; }
        .btn-result:disabled { opacity: 0.35; cursor: default; }
        .btn-result-win { background: #2b7cff; }
        .btn-result-lose { background: #ff5e5e; }
        .score-summary { font-size: 0.78rem; color: var(--text-dim); margin-top: 8px; }
        .score-board { display: grid; grid-template-columns: 1fr auto 1fr; gap: 10px; align-items: center; margin-top: 10px; }
        .score-team { background: #202020; border: 1px solid #2f2f2f; border-radius: 10px; padding: 10px; text-align: center; }
        .score-team.blue { border-color: rgba(0, 123, 255, 0.45); }
        .score-team.red { border-color: rgba(255, 75, 75, 0.45); }
        .score-name { font-size: 0.7rem; color: var(--text-dim); }
        .score-num { font-size: 1.5rem; font-weight: 800; line-height: 1.2; margin-top: 2px; }
        .score-num.blue { color: var(--blue-main); }
        .score-num.red { color: var(--red-main); }
        .score-vs { color: var(--text-dim); font-size: 0.75rem; font-weight: 700; }
        .history-pick { margin-bottom: 6px; line-height: 1.2; }
        .result-badge { display: inline-block; min-width: 20px; padding: 2px 8px; border-radius: 999px; font-size: 0.7rem; font-weight: 700; color: #bbb; background: #2a2a2a; }
        .result-badge.win { color: #7fffc1; background: rgba(46, 204, 113, 0.18); border: 1px solid rgba(46, 204, 113, 0.5); }
        .result-badge.lose { color: #ffc4c4; background: rgba(255, 75, 75, 0.18); border: 1px solid rgba(255, 75, 75, 0.45); }

        .history-section { background: var(--card-bg); border-radius: 15px; padding: 15px; margin-top: 30px; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 0.85rem; }
        th { color: var(--text-dim); font-weight: 400; padding: 10px; border-bottom: 1px solid #333; }
        td { padding: 12px; text-align: center; border-bottom: 1px solid #252525; }
        .latest-row { background: rgba(255,255,255,0.03); }

        .rem-list { display: flex; flex-wrap: wrap; gap: 5px; margin-top: 10px; }
        .rem-item { padding: 4px 8px; font-size: 0.7rem; background: #252525; border-radius: 5px; color: #666; }
        .rem-item.used { text-decoration: line-through; opacity: 0.2; }

        /* --- NAME SELECTOR --- */
        .name-selector-wrap { width: 100%; margin-bottom: 24px; background: var(--card-bg); border-radius: 16px; padding: 20px 24px; box-sizing: border-box; border: 1px solid #2a2a2a; }
        .name-selector-label { font-size: 0.8rem; color: var(--text-dim); margin-bottom: 10px; }
        .name-chips { display: flex; flex-wrap: wrap; gap: 8px; }
        .name-chip { padding: 8px 16px; border-radius: 999px; border: 1px solid #333; background: #252525; color: var(--text-dim); font-size: 0.85rem; cursor: pointer; transition: 0.15s; }
        .name-chip:hover { border-color: #555; }
        .name-chip.selected { background: var(--blue-main); border-color: var(--blue-main); color: #fff; font-weight: 700; }
        .name-chip.occupied { opacity: 0.35; cursor: not-allowed; text-decoration: line-through; }
        .name-chosen-row { display: flex; align-items: center; gap: 10px; font-size: 0.85rem; margin-bottom: 24px; }
        .name-chosen-val { font-weight: 700; color: var(--text-main); }
        .btn-name-change { background: none; border: 1px solid #333; color: var(--text-dim); font-size: 0.75rem; padding: 4px 10px; border-radius: 6px; cursor: pointer; }

        /* --- SAVE SECTION --- */
        .save-section { margin-top: 20px; padding: 16px; background: var(--card-bg); border-radius: 12px; border: 1px solid #2a2a2a; text-align: center; }
        .btn-save { background: #f0c040; color: #111; width: 100%; padding: 16px; border-radius: 12px; border: none; font-size: 1rem; font-weight: 700; cursor: pointer; }
        .btn-save:disabled { background: #333; color: #666; cursor: default; }
        .save-done-text { font-size: 0.85rem; color: var(--success); font-weight: 600; padding: 8px 0; }

        /* --- DAILY BOARD --- */
        .score-pos { color: #2ecc71; font-weight: 700; }
        .score-neg { color: #ff5e5e; font-weight: 700; }
        .score-zero { color: var(--text-dim); }
        .board-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 20px; }
        @media (max-width: 480px) { .board-grid { grid-template-columns: 1fr; } }
    </style>
</head>
<body>

<div id="lobby">
    <div class="lobby-header">
        <h1>StarCraft 2:2</h1>
        <p>ì‹¤ì‹œê°„ ë°´í”½ ì‹œìŠ¤í…œì— ì˜¤ì‹  ê²ƒì„ í™˜ì˜í•©ë‹ˆë‹¤.</p>
    </div>
    
    <!-- NAME SELECTOR -->
    <div class="name-selector-wrap" id="name-selector-wrap">
        <div class="name-selector-label">ë‚´ ì´ë¦„ì„ ì„ íƒí•˜ì„¸ìš”</div>
        <div class="name-chips" id="name-chips"></div>
    </div>
    <div class="name-chosen-row" id="name-chosen-row" style="display:none;">
        <span style="font-size:0.8rem; color:var(--text-dim);">ì„ íƒëœ ì´ë¦„:</span>
        <span class="name-chosen-val" id="name-chosen-val"></span>
        <button class="btn-name-change" onclick="resetNameSelection()">ë³€ê²½</button>
    </div>

    <div class="dashboard-grid">
        <div class="team-section blue-active">
            <div class="team-title blue-title">ğŸ”µ BLUE TEAM</div>
            <div class="role-card selector" id="card-A-Selector" onclick="join('Blue', 'Selector')">
                <span class="role-name">ì„ íƒì (Player)</span>
                <div class="status-badge" id="tag-A-Selector"><span class="dot"></span>ì ‘ì† ê°€ëŠ¥</div>
            </div>
            <div class="role-card viewer" id="card-A-Viewer" onclick="join('Blue', 'Viewer')">
                <span class="role-name">ê´€ì „ì (Spectator)</span>
                <div class="status-badge" id="tag-A-Viewer"><span class="dot"></span>ì ‘ì† ê°€ëŠ¥</div>
            </div>
        </div>

        <div class="team-section red-active">
            <div class="team-title red-title">ğŸ”´ RED TEAM</div>
            <div class="role-card selector" id="card-B-Selector" onclick="join('Red', 'Selector')">
                <span class="role-name">ì„ íƒì (Player)</span>
                <div class="status-badge" id="tag-B-Selector"><span class="dot"></span>ì ‘ì† ê°€ëŠ¥</div>
            </div>
            <div class="role-card viewer" id="card-B-Viewer" onclick="join('Red', 'Viewer')">
                <span class="role-name">ê´€ì „ì (Spectator)</span>
                <div class="status-badge" id="tag-B-Viewer"><span class="dot"></span>ì ‘ì† ê°€ëŠ¥</div>
            </div>
        </div>
    </div>

    <button class="btn-force-reset" style="margin-top:40px;" onclick="showDailyBoard()">
        ğŸ“Š ì¼ìë³„ ë³´ë“œ ë³´ê¸°
    </button>
    <button class="btn-force-reset" style="margin-top:8px;" onclick="handleReset(true)">
        âš ï¸ ì‹œìŠ¤í…œ ê°•ì œ ì´ˆê¸°í™” (ì ‘ì† ì ìœ  í•´ì œ)
    </button>
</div>

<div class="container" id="main-container">
    <header>
        <button class="btn-home" onclick="goHome()">í™ˆí™”ë©´</button>
        <h2 id="round-title">RD 1 / 10</h2>
        <div id="user-tag"></div>
    </header>
    
    <div class="status-container">
        <div class="team-card-ingame" id="ui-card-my"><div style="font-size:0.7rem; color:var(--text-dim);">ìš°ë¦¬ íŒ€</div><div id="ui-pick-my" style="font-weight:700;">-</div></div>
        <div class="team-card-ingame" id="ui-card-opp"><div style="font-size:0.7rem; color:var(--text-dim);">ìƒëŒ€ íŒ€</div><div id="ui-pick-opp" style="font-weight:700;">ëŒ€ê¸° ì¤‘</div></div>
    </div>

    <div class="race-grid" id="main-race-grid"></div>
    <button id="btn-confirm" class="btn-confirm" disabled onclick="confirmSelection()">ì„ íƒ í™•ì •</button>

    <div class="result-panel" id="result-panel" style="display:none;">
        <div class="result-title">Round Result</div>
        <div class="result-hint" id="result-hint">Wait for result input.</div>
        <div class="result-actions">
            <button id="btn-result-win" class="btn-result btn-result-win" onclick="submitRoundResult('W')">My Team Win</button>
            <button id="btn-result-lose" class="btn-result btn-result-lose" onclick="submitRoundResult('L')">My Team Lose</button>
        </div>
    </div>

    <div class="history-section">
        <div style="font-size:0.8rem; font-weight:700;">ìƒëŒ€ ë‚¨ì€ ì¡°í•©</div>
        <div id="opp-rem-list" class="rem-list"></div>
        
        <div style="font-size:0.8rem; font-weight:700; margin-top:25px;">History</div>
        <div class="score-board">
            <div class="score-team blue">
                <div class="score-name">BLUE WINS</div>
                <div id="score-blue" class="score-num blue">0</div>
            </div>
            <div class="score-vs">VS</div>
            <div class="score-team red">
                <div class="score-name">RED WINS</div>
                <div id="score-red" class="score-num red">0</div>
            </div>
        </div>
        <div id="score-summary" class="score-summary">Played 0 / 10</div>
        <table>
            <thead><tr><th>RD</th><th style="color:var(--blue-main)">Blue</th><th style="color:var(--red-main)">Red</th></tr></thead>
            <tbody id="history-body"></tbody>
        </table>
    </div>

    <!-- SAVE SECTION -->
    <div class="save-section" id="save-section" style="display:none;">
        <button class="btn-save" id="btn-save" onclick="saveSession()">ğŸ’¾ ì„¸ì…˜ ì €ì¥</button>
        <div class="save-done-text" id="save-done-text" style="display:none;"></div>
    </div>

    <button onclick="handleReset(false)" style="margin-top:30px; background:none; border:none; color:#444; font-size:0.7rem; width:100%; text-decoration:underline;">ê²½ê¸° ë°ì´í„° ì´ˆê¸°í™”</button>
</div>

<!-- DAILY BOARD SCREEN -->
<div class="container" id="daily-board">
    <header>
        <button class="btn-home" onclick="hideDailyBoard()">â† ë’¤ë¡œ</button>
        <h2>ì ìˆ˜ ë³´ë“œ</h2>
        <div></div>
    </header>
    <div style="display:flex; gap:8px; margin-bottom:20px; align-items:center;">
        <input type="month" id="board-month-input"
            style="flex:1; background:#252525; border:1px solid #333; color:#fff; border-radius:8px; padding:8px 12px; font-size:0.85rem; box-sizing:border-box;" />
        <button onclick="loadBoard()"
            style="background:#333; border:none; color:#fff; padding:8px 16px; border-radius:8px; cursor:pointer; font-size:0.85rem;">ì¡°íšŒ</button>
    </div>
    <div class="board-grid">
        <div class="history-section" style="margin-top:0;">
            <div id="board-month-label" style="font-size:0.8rem; font-weight:700; margin-bottom:8px;">ì›”ë³„ ì ìˆ˜</div>
            <table>
                <thead><tr><th style="text-align:left; padding-left:8px;">ì´ë¦„</th><th>ì ìˆ˜</th></tr></thead>
                <tbody id="board-month-tbody"></tbody>
            </table>
        </div>
        <div class="history-section" style="margin-top:0;">
            <div id="board-year-label" style="font-size:0.8rem; font-weight:700; margin-bottom:8px;">ì—°ê°„ ì ìˆ˜</div>
            <table>
                <thead><tr><th style="text-align:left; padding-left:8px;">ì´ë¦„</th><th>ì ìˆ˜</th></tr></thead>
                <tbody id="board-year-tbody"></tbody>
            </table>
        </div>
    </div>
    <div class="history-section">
        <div style="font-size:0.8rem; font-weight:700; margin-bottom:12px;" id="board-matches-label">ê²½ê¸° ê¸°ë¡</div>
        <div id="board-matches-list"></div>
    </div>
</div>

<script>
    // 2. Firebase ì„¤ì • ë° ì´ˆê¸°í™”
    const firebaseConfig = {
        apiKey: "AIzaSyBAB8mvPNCmL4BHJFq9gDlYktNeA_Ql6m4",
        authDomain: "scpick-d320f.firebaseapp.com",
        databaseURL: "https://scpick-d320f-default-rtdb.asia-southeast1.firebasedatabase.app/",
        projectId: "scpick-d320f",
        storageBucket: "scpick-d320f.appspot.com",
        messagingSenderId: "660478793913",
        appId: "1:660478793913:web:9bc5f9b75d0288128e2368"
    };

    if (!firebaseConfig.apiKey || firebaseConfig.apiKey === "REPLACE_WITH_NEW_API_KEY") {
        alert("ê¸°ì¡´ Firebase API í‚¤ë¥¼ ì œê±°í–ˆìŠµë‹ˆë‹¤. ìƒˆ í‚¤ë¥¼ ë°œê¸‰ë°›ì•„ index.htmlì˜ firebaseConfig.apiKeyì— ë„£ì–´ì£¼ì„¸ìš”.");
        throw new Error("Firebase apiKey is missing");
    }

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // 3. ìµëª… ì¸ì¦ ì‹¤í–‰
    let authReady = false;
    firebase.auth().onAuthStateChanged((user) => { authReady = !!user; });
    firebase.auth().signInAnonymously().catch((e) => {
        console.error("ì¸ì¦ì‹¤íŒ¨:", e.message);
        alert(`Firebase ìµëª… ì¸ì¦ ì‹¤íŒ¨: ${e.message}`);
    });

    function showDbError(err) {
        const msg = (err && (err.message || err.code)) ? (err.message || err.code) : 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜';
        console.error('DB ì‘ì—… ì‹¤íŒ¨:', err);
        alert(`ì €ì¥ ì‹¤íŒ¨: ${msg}`);
    }

    function ensureAuthReady() {
        if (authReady && firebase.auth().currentUser) return true;
        alert('ì¸ì¦ì´ ì•„ì§ ì™„ë£Œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
        return false;
    }

    // --- ê²Œì„ ë¡œì§ ë³€ìˆ˜ ë° í•¨ìˆ˜ ---
    const RACES = [
        { id: 1, label: "ì €ê·¸ + ì €ê·¸" }, { id: 2, label: "ì €ê·¸ + í† ìŠ¤" },
        { id: 3, label: "ì €ê·¸ + í…Œë€" }, { id: 4, label: "ì €ê·¸ + ëœë¤" },
        { id: 5, label: "í† ìŠ¤ + í† ìŠ¤" }, { id: 6, label: "í† ìŠ¤ + í…Œë€" },
        { id: 7, label: "í† ìŠ¤ + ëœë¤" }, { id: 8, label: "í…Œë€ + í…Œë€" },
        { id: 9, label: "í…Œë€ + ëœë¤" }, { id: 10, label: "ëœë¤ + ëœë¤" }
    ];

    let myTeam, myRole, myId = Math.random().toString(36).substr(2, 9);

    const MEMBERS = ['ìˆ˜í•´', 'ì„±ì˜¥', 'ì§„ìˆ˜', 'ìœ¤ìš°', 'ìœ ê°•', 'ë™ì£¼'];
    let myName = localStorage.getItem('sc2_name') || '';
    let currentPresence = {};

    function getOccupiedNames() {
        return Object.values(currentPresence)
            .filter(v => typeof v === 'object' && v.name)
            .map(v => v.name);
    }

    function initNameUI() {
        const chips = document.getElementById('name-chips');
        chips.innerHTML = '';
        const occupiedNames = getOccupiedNames();
        MEMBERS.forEach(name => {
            const isOccupied = occupiedNames.includes(name);
            const chip = document.createElement('div');
            chip.className = 'name-chip'
                + (myName === name ? ' selected' : '')
                + (isOccupied ? ' occupied' : '');
            chip.innerText = isOccupied ? `${name} (ì ‘ì† ì¤‘)` : name;
            chip.onclick = () => { if (!isOccupied) selectName(name); };
            chips.appendChild(chip);
        });
        const wrapEl = document.getElementById('name-selector-wrap');
        const chosenRow = document.getElementById('name-chosen-row');
        const chosenVal = document.getElementById('name-chosen-val');
        if (myName) {
            wrapEl.style.display = 'none';
            chosenRow.style.display = 'flex';
            chosenVal.innerText = myName;
        } else {
            wrapEl.style.display = 'block';
            chosenRow.style.display = 'none';
        }
    }

    function selectName(name) {
        myName = name;
        localStorage.setItem('sc2_name', name);
        initNameUI();
    }

    function resetNameSelection() {
        myName = '';
        localStorage.removeItem('sc2_name');
        initNameUI();
    }

    initNameUI();
    const createInitialState = () => ({
        round: 1,
        aUsed: [],
        bUsed: [],
        aPick: null,
        bPick: null,
        aDone: false,
        bDone: false,
        history: [],
        awaitingResult: false,
        pendingMatch: null,
        saved: false,
        savedAt: null,
        savedByName: null
    });

    function normalizeGameState(state) {
        const safeState = state || {};
        return {
            round: safeState.round || 1,
            aUsed: Array.isArray(safeState.aUsed) ? safeState.aUsed : [],
            bUsed: Array.isArray(safeState.bUsed) ? safeState.bUsed : [],
            aPick: safeState.aPick || null,
            bPick: safeState.bPick || null,
            aDone: !!safeState.aDone,
            bDone: !!safeState.bDone,
            history: Array.isArray(safeState.history) ? safeState.history : [],
            awaitingResult: !!safeState.awaitingResult,
            pendingMatch: safeState.pendingMatch || null,
            saved: !!safeState.saved,
            savedAt: safeState.savedAt || null,
            savedByName: safeState.savedByName || null
        };
    }

    let gameState = createInitialState();

    db.ref('presence').on('value', snap => {
        const pres = snap.val() || {};
        currentPresence = pres;
        initNameUI();
        ['A-Selector', 'B-Selector', 'A-Viewer', 'B-Viewer'].forEach(key => {
            const card = document.getElementById('card-' + key);
            const tag = document.getElementById('tag-' + key);
            if (card && tag) {
                if (pres[key]) {
                    const occupantName = (typeof pres[key] === 'object' && pres[key].name)
                        ? pres[key].name : 'ì ìœ ë¨';
                    card.classList.add('locked');
                    tag.innerHTML = `ì ìœ  ì¤‘ (${occupantName})`;
                } else {
                    card.classList.remove('locked');
                    tag.innerHTML = '<span class="dot"></span>ì ‘ì† ê°€ëŠ¥';
                }
            }
        });
    });

    db.ref('gameState').on('value', snap => { if (snap.exists()) { gameState = normalizeGameState(snap.val()); updateUI(); } });

    function join(teamColor, role) {
        if (!myName) { alert('ì´ë¦„ì„ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”.'); return; }
        if (getOccupiedNames().includes(myName)) {
            alert(`'${myName}'ì€(ëŠ”) ì´ë¯¸ ë‹¤ë¥¸ ìŠ¬ë¡¯ì—ì„œ ì ‘ì† ì¤‘ì…ë‹ˆë‹¤.`);
            return;
        }
        if (!ensureAuthReady()) return;
        myTeam = (teamColor === 'Blue') ? 'A' : 'B';
        myRole = role;
        const key = `${myTeam}-${role}`;
        db.ref('presence/' + key).set({ id: myId, name: myName, joinedAt: Date.now() }).then(() => {
            db.ref('presence/' + key).onDisconnect().remove();
            document.getElementById('lobby').style.display = 'none';
            document.getElementById('main-container').style.display = 'block';
            document.getElementById('user-tag').innerText = `${teamColor} ${role} (${myName})`;
            document.getElementById('user-tag').style.color = (teamColor === 'Blue') ? 'var(--blue-main)' : 'var(--red-main)';
            renderGrids();
        }).catch(showDbError);
    }

    function goHome() {
        if(confirm("ë¡œë¹„ë¡œ ì´ë™í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
            if (!ensureAuthReady()) return;
            const key = `${myTeam}-${myRole}`;
            db.ref('presence/' + key).remove().then(() => {
                location.reload();
            }).catch(showDbError);
        }
    }

    function renderGrids() {
        const grid = document.getElementById('main-race-grid'); grid.innerHTML = '';
        RACES.forEach(r => {
            const d = document.createElement('div'); d.className = 'race-item'; d.id = `race-${r.id}`; d.innerText = r.label;
            d.onclick = () => {
                if (myRole !== 'Selector') return;
                if (!ensureAuthReady()) return;
                const used = myTeam === 'A' ? (gameState.aUsed || []) : (gameState.bUsed || []);
                const done = myTeam === 'A' ? gameState.aDone : gameState.bDone;
                if (!used.includes(r.id) && !done && !gameState.awaitingResult && gameState.round <= 10) {
                    if (myTeam === 'A') gameState.aPick = r; else gameState.bPick = r;
                    db.ref('gameState').set(gameState).catch(showDbError);
                }
            };
            grid.appendChild(d);
        });
        const remList = document.getElementById('opp-rem-list'); remList.innerHTML = '';
        RACES.forEach(r => {
            const s = document.createElement('span'); s.className = 'rem-item'; s.id = `rem-${r.id}`; s.innerText = r.label; remList.appendChild(s);
        });
    }

    function confirmSelection() {
        if (!ensureAuthReady()) return;
        if (myRole !== 'Selector' || gameState.awaitingResult || gameState.round > 10) return;
        if (myTeam === 'A' && !gameState.aPick) return;
        if (myTeam === 'B' && !gameState.bPick) return;

        if (myTeam === 'A') gameState.aDone = true; else gameState.bDone = true;
        if (gameState.aDone && gameState.bDone) {
            if (!gameState.aPick || !gameState.bPick) return;
            gameState.awaitingResult = true;
            gameState.pendingMatch = { r: gameState.round, a: gameState.aPick, b: gameState.bPick };
        }
        db.ref('gameState').set(gameState).catch(showDbError);
    }

    function submitRoundResult(myResult) {
        if (!ensureAuthReady()) return;
        if (myRole !== 'Selector' || !gameState.awaitingResult || !gameState.pendingMatch) return;
        if (myResult !== 'W' && myResult !== 'L') return;

        if (!gameState.history) gameState.history = [];
        if (!gameState.aUsed) gameState.aUsed = [];
        if (!gameState.bUsed) gameState.bUsed = [];

        const winner = myResult === 'W' ? myTeam : (myTeam === 'A' ? 'B' : 'A');
        const aResult = winner === 'A' ? 'W' : 'L';
        const bResult = winner === 'B' ? 'W' : 'L';
        const roundNo = gameState.pendingMatch.r || gameState.round;

        // Prevent duplicate write for same round in the same client state.
        if (gameState.history.some(h => h.r === roundNo)) return;

        const roundHistory = {
            r: roundNo,
            a: gameState.pendingMatch.a,
            b: gameState.pendingMatch.b,
            winner,
            aResult,
            bResult
        };
        gameState.history.push(roundHistory);

        if (roundHistory.a && roundHistory.a.id && !gameState.aUsed.includes(roundHistory.a.id)) gameState.aUsed.push(roundHistory.a.id);
        if (roundHistory.b && roundHistory.b.id && !gameState.bUsed.includes(roundHistory.b.id)) gameState.bUsed.push(roundHistory.b.id);

        gameState.round++;
        gameState.aDone = false;
        gameState.bDone = false;
        gameState.aPick = null;
        gameState.bPick = null;
        gameState.awaitingResult = false;
        gameState.pendingMatch = null;

        db.ref('gameState').set(gameState).catch(showDbError);
    }

    function formatTimestamp(ts) {
        if (!ts) return '';
        const d = new Date(ts);
        return `${d.getMonth() + 1}/${d.getDate()} ${String(d.getHours()).padStart(2, '0')}:${String(d.getMinutes()).padStart(2, '0')}`;
    }

    function getDateKeyKST() {
        // Asia/Seoul = UTC+9
        const kst = new Date(Date.now() + 9 * 60 * 60 * 1000);
        const y = kst.getUTCFullYear();
        const m = String(kst.getUTCMonth() + 1).padStart(2, '0');
        const d = String(kst.getUTCDate()).padStart(2, '0');
        return `${y}-${m}-${d}`;
    }

    function saveSessionCore(savedState) {
        // presenceì—ì„œ 4ê°œ ìŠ¬ë¡¯ ì´ë¦„ ì½ê¸°
        function slotName(key) {
            const v = currentPresence[key];
            return (v && typeof v === 'object' && v.name) ? v.name : null;
        }
        const aSelector = slotName('A-Selector');
        const aViewer   = slotName('A-Viewer');
        const bSelector = slotName('B-Selector');
        const bViewer   = slotName('B-Viewer');

        // history ì •ê·œí™” (Firebase ë°°ì—´â†’ê°ì²´ ì—­ì§ë ¬í™” ëŒ€ë¹„)
        const toArr = v => Array.isArray(v) ? v : (v ? Object.values(v) : []);
        const history = toArr(savedState.history);

        // blueWins / redWins ê³„ì‚°
        let blueWins = 0, redWins = 0;
        history.forEach(h => {
            if (h.winner === 'A' || h.aResult === 'W') blueWins++;
            if (h.winner === 'B' || h.bResult === 'W') redWins++;
        });

        const diff = Math.abs(blueWins - redWins);
        const winnerTeam = blueWins > redWins ? 'A' : (redWins > blueWins ? 'B' : 'draw');

        // sessionPoints: 6ëª… ì „ì²´ ëª…ì‹œ ì €ì¥
        // ì°¸ê°€ì: ìŠ¹ë¦¬íŒ€ +diff / íŒ¨ë°°íŒ€ -diff, diff==0 ì´ë©´ ëª¨ë‘ 0
        const sessionPoints = {};
        MEMBERS.forEach(name => { sessionPoints[name] = 0; });

        function applyPts(name, team) {
            if (!name || diff === 0) return;
            sessionPoints[name] = (team === winnerTeam) ? diff : -diff;
        }
        applyPts(aSelector, 'A');
        applyPts(aViewer,   'A');
        applyPts(bSelector, 'B');
        applyPts(bViewer,   'B');

        const dateKey   = getDateKeyKST();
        const sessionId = `${Date.now()}_${Math.random().toString(36).substr(2, 6)}`;

        const sessionData = {
            createdAt:    Date.now(),
            savedAt:      savedState.savedAt || Date.now(),
            savedByName:  savedState.savedByName || myName,
            players:      { aSelector, aViewer, bSelector, bViewer },
            blueWins,
            redWins,
            diff,
            winnerTeam,
            history,
            sessionPoints
        };

        db.ref(`matches/${dateKey}/${sessionId}`).set(sessionData)
            .then(() => {
                if (diff === 0) return; // ëª¨ë‘ 0ì ì´ë©´ statsDaily ì—…ë°ì´íŠ¸ ìƒëµ
                const txns = [];
                Object.entries(sessionPoints).forEach(([name, pts]) => {
                    if (pts === 0) return; // ì ìˆ˜ ì—†ëŠ” ë¹„ì°¸ê°€ì skip
                    txns.push(
                        db.ref(`statsDaily/${dateKey}/${name}`)
                          .transaction(cur => (cur || 0) + pts)
                    );
                });
                return Promise.all(txns);
            })
            .catch(showDbError);
    }

    function saveSession() {
        if (!ensureAuthReady()) return;
        const btnSave = document.getElementById('btn-save');
        if (btnSave) btnSave.disabled = true;

        db.ref('gameState').transaction(current => {
            if (!current) return current;   // ë°ì´í„° ì—†ìœ¼ë©´ ì¤‘ë‹¨
            if (current.saved) return;      // ì´ë¯¸ ì €ì¥ë¨ â†’ abort (undefined ë°˜í™˜)

            const toArr = v => Array.isArray(v) ? v : (v ? Object.values(v) : []);
            return Object.assign({}, current, {
                aUsed: toArr(current.aUsed),
                bUsed: toArr(current.bUsed),
                history: toArr(current.history),
                saved: true,
                savedAt: Date.now(),
                savedByName: myName
            });
        }, (err, committed, snap) => {
            if (err) {
                showDbError(err);
                if (btnSave) btnSave.disabled = false;
                return;
            }
            if (committed) {
                saveSessionCore(snap.val());
            } else {
                alert('ì´ë¯¸ ë‹¤ë¥¸ ì°¸ê°€ìê°€ ì €ì¥í–ˆìŠµë‹ˆë‹¤.');
            }
        });
    }

    function showDailyBoard() {
        document.getElementById('lobby').style.display = 'none';
        document.getElementById('daily-board').style.display = 'block';
        const kst = new Date(Date.now() + 9 * 60 * 60 * 1000);
        const y = kst.getUTCFullYear();
        const m = String(kst.getUTCMonth() + 1).padStart(2, '0');
        document.getElementById('board-month-input').value = `${y}-${m}`;
        loadBoard();
    }

    function hideDailyBoard() {
        document.getElementById('daily-board').style.display = 'none';
        document.getElementById('lobby').style.display = 'flex';
    }

    // statsDaily ìŠ¤ëƒ…ìƒ· val({dateKey: {name: pts}})ì„ MEMBERSë³„ í•©ì‚°ìœ¼ë¡œ ë³€í™˜
    function aggregateScores(val) {
        const totals = {};
        MEMBERS.forEach(n => { totals[n] = 0; });
        if (!val || typeof val !== 'object') return totals;
        Object.values(val).forEach(dayData => {
            if (!dayData || typeof dayData !== 'object') return;
            MEMBERS.forEach(name => {
                if (typeof dayData[name] === 'number') totals[name] += dayData[name];
            });
        });
        return totals;
    }

    function renderScoreTable(tbodyId, totals) {
        const tbody = document.getElementById(tbodyId);
        tbody.innerHTML = '';
        const sorted = MEMBERS.slice().sort((a, b) => (totals[b] || 0) - (totals[a] || 0));
        sorted.forEach(name => {
            const pts = totals[name] || 0;
            const cls = pts > 0 ? 'score-pos' : (pts < 0 ? 'score-neg' : 'score-zero');
            const sign = pts > 0 ? '+' : '';
            tbody.innerHTML += `<tr><td style="text-align:left; padding-left:8px;">${name}</td><td class="${cls}">${sign}${pts}</td></tr>`;
        });
    }

    function renderMatchList(matchVal, yearMonth) {
        const container = document.getElementById('board-matches-list');
        document.getElementById('board-matches-label').innerText = `${yearMonth} ê²½ê¸° ê¸°ë¡`;
        if (!matchVal || typeof matchVal !== 'object') {
            container.innerHTML = '<div style="color:var(--text-dim); font-size:0.8rem; padding:8px 0;">ì´ ë‹¬ ê²½ê¸° ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
            return;
        }
        const dateKeys = Object.keys(matchVal).sort().reverse();
        if (dateKeys.length === 0) {
            container.innerHTML = '<div style="color:var(--text-dim); font-size:0.8rem; padding:8px 0;">ì´ ë‹¬ ê²½ê¸° ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
            return;
        }
        container.innerHTML = '';
        dateKeys.forEach(dateKey => {
            const sessions = matchVal[dateKey] || {};
            const sessionList = Object.values(sessions)
                .filter(s => s && typeof s === 'object')
                .sort((a, b) => (a.createdAt || 0) - (b.createdAt || 0));
            let html = `<div style="font-size:0.78rem; color:var(--text-dim); font-weight:700; margin:12px 0 6px; border-bottom:1px solid #2a2a2a; padding-bottom:4px;">${dateKey}</div>`;
            sessionList.forEach(s => {
                const bw = s.blueWins !== undefined ? s.blueWins : '?';
                const rw = s.redWins !== undefined ? s.redWins : '?';
                const aS = (s.players && s.players.aSelector) || '?';
                const aV = (s.players && s.players.aViewer) || '-';
                const bS = (s.players && s.players.bSelector) || '?';
                const bV = (s.players && s.players.bViewer) || '-';
                const winTag = s.winnerTeam === 'A'
                    ? `<span style="color:var(--blue-main);font-weight:700;font-size:0.7rem;">BLUE WIN</span>`
                    : s.winnerTeam === 'B'
                    ? `<span style="color:var(--red-main);font-weight:700;font-size:0.7rem;">RED WIN</span>`
                    : `<span style="color:var(--text-dim);font-size:0.7rem;">DRAW</span>`;
                const timeStr = s.createdAt ? formatTimestamp(s.createdAt) : '';
                html += `<div style="background:#1e1e1e;border-radius:8px;padding:10px 12px;margin-bottom:6px;">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;">
                        <span style="color:var(--text-dim);font-size:0.72rem;">${timeStr}</span>${winTag}
                    </div>
                    <div style="display:grid;grid-template-columns:1fr auto 1fr;align-items:center;gap:8px;text-align:center;">
                        <div>
                            <div style="color:var(--blue-main);font-weight:600;font-size:0.82rem;">${aS}</div>
                            <div style="color:var(--blue-main);opacity:0.6;font-size:0.7rem;">${aV}</div>
                        </div>
                        <div style="font-weight:800;font-size:1.1rem;">${bw}:${rw}</div>
                        <div>
                            <div style="color:var(--red-main);font-weight:600;font-size:0.82rem;">${bS}</div>
                            <div style="color:var(--red-main);opacity:0.6;font-size:0.7rem;">${bV}</div>
                        </div>
                    </div>
                </div>`;
            });
            const dayDiv = document.createElement('div');
            dayDiv.innerHTML = html;
            container.appendChild(dayDiv);
        });
    }

    function loadBoard() {
        const yearMonth = document.getElementById('board-month-input').value;
        if (!yearMonth) return;
        const year = yearMonth.slice(0, 4);
        const monthPfx = yearMonth + '-';
        const yearPfx  = year + '-';

        document.getElementById('board-month-label').innerText = `${yearMonth} ì›”ë³„ ì ìˆ˜`;
        document.getElementById('board-year-label').innerText  = `${year}ë…„ ì—°ê°„ ì ìˆ˜`;
        ['board-month-tbody', 'board-year-tbody'].forEach(id => {
            document.getElementById(id).innerHTML = '<tr><td colspan="2" style="color:var(--text-dim);font-size:0.8rem;">ë¡œë”© ì¤‘...</td></tr>';
        });
        document.getElementById('board-matches-list').innerHTML = '<div style="color:var(--text-dim);font-size:0.8rem;">ë¡œë”© ì¤‘...</div>';

        const safe = ref => ref.once('value').catch(err => {
            console.warn('board query failed:', err.message || err);
            return null;
        });

        Promise.all([
            safe(db.ref('statsDaily').orderByKey().startAt(monthPfx).endAt(monthPfx + '\uf8ff')),
            safe(db.ref('statsDaily').orderByKey().startAt(yearPfx).endAt(yearPfx + '\uf8ff')),
            safe(db.ref('matches').orderByKey().startAt(monthPfx).endAt(monthPfx + '\uf8ff'))
        ]).then(([monthSnap, yearSnap, matchSnap]) => {
            const monthVal = monthSnap ? monthSnap.val() : null;
            const yearVal  = yearSnap  ? yearSnap.val()  : null;
            const matchVal = matchSnap ? matchSnap.val() : null;

            if (monthVal === null && yearVal === null && matchVal === null) {
                const errRow = '<tr><td colspan="2" style="color:#ff5e5e;font-size:0.75rem;">ì½ê¸° ê¶Œí•œ ì—†ìŒ â€” Firebase Rules í™•ì¸ í•„ìš”</td></tr>';
                document.getElementById('board-month-tbody').innerHTML = errRow;
                document.getElementById('board-year-tbody').innerHTML  = errRow;
                document.getElementById('board-matches-list').innerHTML = '<div style="color:#ff5e5e;font-size:0.75rem;">Firebase RTDB Rulesì—ì„œ statsDaily, matches ì½ê¸° ê¶Œí•œì„ í—ˆìš©í•´ì£¼ì„¸ìš”.</div>';
                return;
            }
            renderScoreTable('board-month-tbody', aggregateScores(monthVal));
            renderScoreTable('board-year-tbody',  aggregateScores(yearVal));
            renderMatchList(matchVal, yearMonth);
        });
    }

    function handleReset(isForce) {
        if (confirm(isForce ? "ì‹œìŠ¤í…œì„ ê°•ì œ ì´ˆê¸°í™”í• ê¹Œìš”?" : "ë°ì´í„°ë¥¼ ì´ˆê¸°í™”í• ê¹Œìš”?")) {
            if (!ensureAuthReady()) return;
            db.ref('gameState').set(createInitialState()).then(() => {
                if (isForce) db.ref('presence').remove().then(() => { location.reload(); }).catch(showDbError);
            }).catch(showDbError);
        }
    }

    function updateUI() {
        document.getElementById('round-title').innerText = gameState.round > 10 ? "Draft Ended" : `ROUND ${gameState.round} / 10`;
        const myDone = myTeam === 'A' ? gameState.aDone : gameState.bDone;
        const myPick = myTeam === 'A' ? gameState.aPick : gameState.bPick;
        const oppDone = myTeam === 'A' ? gameState.bDone : gameState.aDone;
        document.getElementById('ui-pick-my').innerText = myPick ? myPick.label : "-";
        document.getElementById('ui-pick-opp').innerText = gameState.awaitingResult ? "Result pending..." : (oppDone ? "Ready" : "Selecting...");
        
        const myUsed = myTeam === 'A' ? (gameState.aUsed || []) : (gameState.bUsed || []);
        const oppUsed = myTeam === 'A' ? (gameState.bUsed || []) : (gameState.aUsed || []);

        RACES.forEach(r => {
            const el = document.getElementById(`race-${r.id}`);
            if (el) {
                el.className = 'race-item';
                if (myUsed.includes(r.id)) el.classList.add('used');
                if (myPick && myPick.id === r.id) el.classList.add('selected');
            }
            const rel = document.getElementById(`rem-${r.id}`);
            if (rel) rel.className = oppUsed.includes(r.id) ? 'rem-item used' : 'rem-item';
        });

        document.getElementById('btn-confirm').disabled = (myRole !== 'Selector' || !myPick || myDone || gameState.round > 10 || gameState.awaitingResult);
        
        const resultPanel = document.getElementById('result-panel');
        const resultHint = document.getElementById('result-hint');
        const btnResultWin = document.getElementById('btn-result-win');
        const btnResultLose = document.getElementById('btn-result-lose');
        if (resultPanel && resultHint && btnResultWin && btnResultLose) {
            const canSubmitResult = (myRole === 'Selector' && gameState.awaitingResult && gameState.round <= 10);
            resultPanel.style.display = gameState.awaitingResult ? 'block' : 'none';
            resultHint.innerText = canSubmitResult ? `Round ${gameState.round}: choose win/loss for your team.` : `Round ${gameState.round}: waiting for selector result input.`;
            btnResultWin.disabled = !canSubmitResult;
            btnResultLose.disabled = !canSubmitResult;
        }
        
        const tbody = document.getElementById('history-body'); tbody.innerHTML = '';
        if (gameState.history) {
            const sortedHistory = gameState.history.slice().reverse();
            sortedHistory.forEach((h, index) => {
                const rowClass = index === 0 ? 'class="latest-row"' : '';
                const aLabel = h.a && h.a.label ? h.a.label : '-';
                const bLabel = h.b && h.b.label ? h.b.label : '-';
                const aResult = h.aResult || '-';
                const bResult = h.bResult || '-';
                const aBadgeClass = aResult === 'W' ? 'result-badge win' : (aResult === 'L' ? 'result-badge lose' : 'result-badge');
                const bBadgeClass = bResult === 'W' ? 'result-badge win' : (bResult === 'L' ? 'result-badge lose' : 'result-badge');
                tbody.innerHTML += `<tr ${rowClass}><td>${h.r}</td><td style="color:var(--blue-main)"><div class="history-pick">${aLabel}</div><span class="${aBadgeClass}">${aResult}</span></td><td style="color:var(--red-main)"><div class="history-pick">${bLabel}</div><span class="${bBadgeClass}">${bResult}</span></td></tr>`;
            });
        }

        const scoreSummary = document.getElementById('score-summary');
        const scoreBlue = document.getElementById('score-blue');
        const scoreRed = document.getElementById('score-red');
        if (scoreSummary && scoreBlue && scoreRed) {
            let blueWins = 0;
            let redWins = 0;
            (gameState.history || []).forEach(h => {
                if (h.winner === 'A' || h.aResult === 'W') blueWins++;
                if (h.winner === 'B' || h.bResult === 'W') redWins++;
            });
            const played = (gameState.history || []).length;
            scoreBlue.innerText = String(blueWins);
            scoreRed.innerText = String(redWins);
            scoreSummary.innerText = gameState.awaitingResult ? `Result pending for Round ${gameState.round}  |  Played ${played} / 10` : `Played ${played} / 10`;
        }

        // Save section
        const saveSection = document.getElementById('save-section');
        const btnSave = document.getElementById('btn-save');
        const saveDoneText = document.getElementById('save-done-text');
        if (saveSection && btnSave && saveDoneText) {
            const playedCount = (gameState.history || []).length;
            const isDone = playedCount === 10 && !gameState.awaitingResult;
            if (!isDone) {
                saveSection.style.display = 'none';
            } else if (gameState.saved) {
                saveSection.style.display = 'block';
                btnSave.style.display = 'none';
                saveDoneText.style.display = 'block';
                saveDoneText.innerText = `âœ… ì €ì¥ ì™„ë£Œ: ${gameState.savedByName || '?'} (${formatTimestamp(gameState.savedAt)})`;
            } else {
                saveSection.style.display = 'block';
                btnSave.style.display = 'block';
                btnSave.disabled = false;
                saveDoneText.style.display = 'none';
            }
        }
    }
</script>
</body>
</html>
