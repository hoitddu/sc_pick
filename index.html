<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SC2 2:2 PICK DASHBOARD</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <style>
        @import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css');

        :root { 
            --bg-color: #0f0f0f;
            --blue-main: #007BFF;
            --blue-soft: rgba(0, 123, 255, 0.1);
            --red-main: #FF4B4B;
            --red-soft: rgba(255, 75, 75, 0.1);
            --success: #2ecc71;
            --card-bg: #1a1a1a;
            --text-main: #ffffff;
            --text-dim: #a0a0a0;
        }

        body { 
            font-family: 'Pretendard', sans-serif; 
            background-color: var(--bg-color); 
            color: var(--text-main); 
            margin: 0; padding: 0; 
            display: flex; flex-direction: column; align-items: center; 
            min-height: 100vh; -webkit-tap-highlight-color: transparent;
        }

        /* --- LOBBY DESIGN --- */
        #lobby { 
            display: flex; flex-direction: column; align-items: center; justify-content: center; 
            width: 100%; max-width: 800px; min-height: 100vh; padding: 20px; box-sizing: border-box;
        }

        .lobby-header { text-align: center; margin-bottom: 40px; }
        .lobby-header h1 { font-size: 1.8rem; letter-spacing: -0.5px; margin-bottom: 10px; }
        .lobby-header p { color: var(--text-dim); font-size: 0.9rem; }

        .dashboard-grid { 
            display: grid; grid-template-columns: 1fr 1fr; gap: 20px; width: 100%; 
        }

        @media (max-width: 600px) {
            .dashboard-grid { grid-template-columns: 1fr; }
        }

        .team-section { 
            background: var(--card-bg); border-radius: 20px; padding: 24px; 
            display: flex; flex-direction: column; gap: 16px; border: 1px solid #2a2a2a;
        }

        .team-title { font-size: 1.1rem; font-weight: 700; margin-bottom: 8px; display: flex; align-items: center; gap: 8px; }
        .blue-title { color: var(--blue-main); }
        .red-title { color: var(--red-main); }

        .role-card { 
            position: relative; border-radius: 12px; padding: 20px; cursor: pointer; 
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); border: 1px solid transparent;
        }

        .role-card.selector { background: #252525; border: 1px solid #333; }
        .role-card.selector:hover { transform: translateY(-2px); border-color: #444; }

        .blue-active .role-card.selector { background: var(--blue-main); }
        .red-active .role-card.selector { background: var(--red-main); }

        .role-card.viewer { background: transparent; border: 1px dashed #333; padding: 15px; }
        .blue-active .role-card.viewer { border-color: var(--blue-main); color: var(--blue-main); }
        .red-active .role-card.viewer { border-color: var(--red-main); color: var(--red-main); }

        .role-name { font-weight: 600; font-size: 1rem; margin-bottom: 4px; display: block; }
        
        .status-badge { font-size: 0.75rem; display: flex; align-items: center; gap: 5px; opacity: 0.8; }
        .dot { width: 6px; height: 6px; background-color: var(--success); border-radius: 50%; display: inline-block; box-shadow: 0 0 8px var(--success); animation: blink 1.5s infinite; }
        
        @keyframes blink { 0% { opacity: 0.4; } 50% { opacity: 1; } 100% { opacity: 0.4; } }

        .locked { opacity: 0.2 !important; filter: grayscale(1); pointer-events: none; }

        .btn-force-reset { margin-top: 60px; background: none; border: none; color: #555; font-size: 0.75rem; cursor: pointer; display: flex; align-items: center; gap: 5px; }

        /* --- GAME UI --- */
        .container { width: 100%; max-width: 500px; display: none; padding: 15px; box-sizing: border-box; }
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .btn-home { background: #252525; color: var(--text-dim); border: 1px solid #333; padding: 8px 16px; border-radius: 8px; font-size: 0.8rem; cursor: pointer; }
        
        .status-container { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 20px; }
        .team-card-ingame { padding: 15px; border-radius: 12px; background: var(--card-bg); text-align: center; border-bottom: 4px solid #333; }
        
        .race-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .race-item { padding: 20px 10px; background: #222; border-radius: 10px; text-align: center; border: 2px solid transparent; cursor: pointer; transition: 0.2s; font-size: 0.9rem; }
        .race-item.selected { border-color: var(--success); background: rgba(46, 204, 113, 0.1); font-weight: bold; }
        .race-item.used { opacity: 0.15; pointer-events: none; text-decoration: line-through; }
        
        .btn-confirm { background: var(--success); color: white; width: 100%; padding: 18px; border-radius: 12px; border: none; font-size: 1.1rem; font-weight: 700; margin-top: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.4); }
        .btn-confirm:disabled { background: #333; box-shadow: none; color: #666; }
        .result-panel { margin-top: 14px; background: #161616; border: 1px solid #2a2a2a; border-radius: 12px; padding: 14px; }
        .result-title { font-size: 0.9rem; font-weight: 700; }
        .result-hint { font-size: 0.78rem; color: var(--text-dim); margin-top: 6px; }
        .result-actions { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 12px; }
        .btn-result { border: none; border-radius: 10px; padding: 12px 8px; color: #fff; font-weight: 700; cursor: pointer; }
        .btn-result:disabled { opacity: 0.35; cursor: default; }
        .btn-result-win { background: #2b7cff; }
        .btn-result-lose { background: #ff5e5e; }
        .score-summary { font-size: 0.78rem; color: var(--text-dim); margin-top: 8px; }
        .score-board { display: grid; grid-template-columns: 1fr auto 1fr; gap: 10px; align-items: center; margin-top: 10px; }
        .score-team { background: #202020; border: 1px solid #2f2f2f; border-radius: 10px; padding: 10px; text-align: center; }
        .score-team.blue { border-color: rgba(0, 123, 255, 0.45); }
        .score-team.red { border-color: rgba(255, 75, 75, 0.45); }
        .score-name { font-size: 0.7rem; color: var(--text-dim); }
        .score-num { font-size: 1.5rem; font-weight: 800; line-height: 1.2; margin-top: 2px; }
        .score-num.blue { color: var(--blue-main); }
        .score-num.red { color: var(--red-main); }
        .score-vs { color: var(--text-dim); font-size: 0.75rem; font-weight: 700; }
        .history-pick { margin-bottom: 6px; line-height: 1.2; }
        .result-badge { display: inline-block; min-width: 20px; padding: 2px 8px; border-radius: 999px; font-size: 0.7rem; font-weight: 700; color: #bbb; background: #2a2a2a; }
        .result-badge.win { color: #7fffc1; background: rgba(46, 204, 113, 0.18); border: 1px solid rgba(46, 204, 113, 0.5); }
        .result-badge.lose { color: #ffc4c4; background: rgba(255, 75, 75, 0.18); border: 1px solid rgba(255, 75, 75, 0.45); }

        .history-section { background: var(--card-bg); border-radius: 15px; padding: 15px; margin-top: 30px; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 0.85rem; }
        th { color: var(--text-dim); font-weight: 400; padding: 10px; border-bottom: 1px solid #333; }
        td { padding: 12px; text-align: center; border-bottom: 1px solid #252525; }
        .latest-row { background: rgba(255,255,255,0.03); }

        .rem-list { display: flex; flex-wrap: wrap; gap: 5px; margin-top: 10px; }
        .rem-item { padding: 4px 8px; font-size: 0.7rem; background: #252525; border-radius: 5px; color: #666; }
        .rem-item.used { text-decoration: line-through; opacity: 0.2; }
    </style>
</head>
<body>

<div id="lobby">
    <div class="lobby-header">
        <h1>StarCraft 2:2</h1>
        <p>Ïã§ÏãúÍ∞Ñ Î∞¥ÌîΩ ÏãúÏä§ÌÖúÏóê Ïò§Ïã† Í≤ÉÏùÑ ÌôòÏòÅÌï©ÎãàÎã§.</p>
    </div>
    
    <div class="dashboard-grid">
        <div class="team-section blue-active">
            <div class="team-title blue-title">üîµ BLUE TEAM</div>
            <div class="role-card selector" id="card-A-Selector" onclick="join('Blue', 'Selector')">
                <span class="role-name">ÏÑ†ÌÉùÏûê (Player)</span>
                <div class="status-badge" id="tag-A-Selector"><span class="dot"></span>Ï†ëÏÜç Í∞ÄÎä•</div>
            </div>
            <div class="role-card viewer" id="card-A-Viewer" onclick="join('Blue', 'Viewer')">
                <span class="role-name">Í¥ÄÏ†ÑÏûê (Spectator)</span>
                <div class="status-badge" id="tag-A-Viewer"><span class="dot"></span>Ï†ëÏÜç Í∞ÄÎä•</div>
            </div>
        </div>

        <div class="team-section red-active">
            <div class="team-title red-title">üî¥ RED TEAM</div>
            <div class="role-card selector" id="card-B-Selector" onclick="join('Red', 'Selector')">
                <span class="role-name">ÏÑ†ÌÉùÏûê (Player)</span>
                <div class="status-badge" id="tag-B-Selector"><span class="dot"></span>Ï†ëÏÜç Í∞ÄÎä•</div>
            </div>
            <div class="role-card viewer" id="card-B-Viewer" onclick="join('Red', 'Viewer')">
                <span class="role-name">Í¥ÄÏ†ÑÏûê (Spectator)</span>
                <div class="status-badge" id="tag-B-Viewer"><span class="dot"></span>Ï†ëÏÜç Í∞ÄÎä•</div>
            </div>
        </div>
    </div>

    <button class="btn-force-reset" onclick="handleReset(true)">
        ‚ö†Ô∏è ÏãúÏä§ÌÖú Í∞ïÏ†ú Ï¥àÍ∏∞Ìôî (Ï†ëÏÜç Ï†êÏú† Ìï¥Ï†ú)
    </button>
</div>

<div class="container" id="main-container">
    <header>
        <button class="btn-home" onclick="goHome()">ÌôàÌôîÎ©¥</button>
        <h2 id="round-title">RD 1 / 10</h2>
        <div id="user-tag"></div>
    </header>
    
    <div class="status-container">
        <div class="team-card-ingame" id="ui-card-my"><div style="font-size:0.7rem; color:var(--text-dim);">Ïö∞Î¶¨ ÌåÄ</div><div id="ui-pick-my" style="font-weight:700;">-</div></div>
        <div class="team-card-ingame" id="ui-card-opp"><div style="font-size:0.7rem; color:var(--text-dim);">ÏÉÅÎåÄ ÌåÄ</div><div id="ui-pick-opp" style="font-weight:700;">ÎåÄÍ∏∞ Ï§ë</div></div>
    </div>

    <div class="race-grid" id="main-race-grid"></div>
    <button id="btn-confirm" class="btn-confirm" disabled onclick="confirmSelection()">ÏÑ†ÌÉù ÌôïÏ†ï</button>

    <div class="result-panel" id="result-panel" style="display:none;">
        <div class="result-title">Round Result</div>
        <div class="result-hint" id="result-hint">Wait for result input.</div>
        <div class="result-actions">
            <button id="btn-result-win" class="btn-result btn-result-win" onclick="submitRoundResult('W')">My Team Win</button>
            <button id="btn-result-lose" class="btn-result btn-result-lose" onclick="submitRoundResult('L')">My Team Lose</button>
        </div>
    </div>

    <div class="history-section">
        <div style="font-size:0.8rem; font-weight:700;">ÏÉÅÎåÄ ÎÇ®ÏùÄ Ï°∞Ìï©</div>
        <div id="opp-rem-list" class="rem-list"></div>
        
        <div style="font-size:0.8rem; font-weight:700; margin-top:25px;">History</div>
        <div class="score-board">
            <div class="score-team blue">
                <div class="score-name">BLUE WINS</div>
                <div id="score-blue" class="score-num blue">0</div>
            </div>
            <div class="score-vs">VS</div>
            <div class="score-team red">
                <div class="score-name">RED WINS</div>
                <div id="score-red" class="score-num red">0</div>
            </div>
        </div>
        <div id="score-summary" class="score-summary">Played 0 / 10</div>
        <table>
            <thead><tr><th>RD</th><th style="color:var(--blue-main)">Blue</th><th style="color:var(--red-main)">Red</th></tr></thead>
            <tbody id="history-body"></tbody>
        </table>
    </div>
    <button onclick="handleReset(false)" style="margin-top:30px; background:none; border:none; color:#444; font-size:0.7rem; width:100%; text-decoration:underline;">Í≤ΩÍ∏∞ Îç∞Ïù¥ÌÑ∞ Ï¥àÍ∏∞Ìôî</button>
</div>

<script>
    // 2. Firebase ÏÑ§Ï†ï Î∞è Ï¥àÍ∏∞Ìôî
    const firebaseConfig = {
        apiKey: "AIzaSyBAB8mvPNCmL4BHJFq9gDlYktNeA_Ql6m4",
        authDomain: "scpick-d320f.firebaseapp.com",
        databaseURL: "https://scpick-d320f-default-rtdb.asia-southeast1.firebasedatabase.app/",
        projectId: "scpick-d320f",
        storageBucket: "scpick-d320f.appspot.com",
        messagingSenderId: "660478793913",
        appId: "1:660478793913:web:9bc5f9b75d0288128e2368"
    };

    if (!firebaseConfig.apiKey || firebaseConfig.apiKey === "REPLACE_WITH_NEW_API_KEY") {
        alert("Í∏∞Ï°¥ Firebase API ÌÇ§Î•º Ï†úÍ±∞ÌñàÏäµÎãàÎã§. ÏÉà ÌÇ§Î•º Î∞úÍ∏âÎ∞õÏïÑ index.htmlÏùò firebaseConfig.apiKeyÏóê ÎÑ£Ïñ¥Ï£ºÏÑ∏Ïöî.");
        throw new Error("Firebase apiKey is missing");
    }

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // 3. ÏùµÎ™Ö Ïù∏Ï¶ù Ïã§Ìñâ
    let authReady = false;
    firebase.auth().onAuthStateChanged((user) => { authReady = !!user; });
    firebase.auth().signInAnonymously().catch((e) => {
        console.error("Ïù∏Ï¶ùÏã§Ìå®:", e.message);
        alert(`Firebase ÏùµÎ™Ö Ïù∏Ï¶ù Ïã§Ìå®: ${e.message}`);
    });

    function showDbError(err) {
        const msg = (err && (err.message || err.code)) ? (err.message || err.code) : 'Ïïå Ïàò ÏóÜÎäî Ïò§Î•ò';
        console.error('DB ÏûëÏóÖ Ïã§Ìå®:', err);
        alert(`Ï†ÄÏû• Ïã§Ìå®: ${msg}`);
    }

    function ensureAuthReady() {
        if (authReady && firebase.auth().currentUser) return true;
        alert('Ïù∏Ï¶ùÏù¥ ÏïÑÏßÅ ÏôÑÎ£åÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§. Ïû†Ïãú ÌõÑ Îã§Ïãú ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî.');
        return false;
    }

    // --- Í≤åÏûÑ Î°úÏßÅ Î≥ÄÏàò Î∞è Ìï®Ïàò ---
    const RACES = [
        { id: 1, label: "Ï†ÄÍ∑∏ + Ï†ÄÍ∑∏" }, { id: 2, label: "Ï†ÄÍ∑∏ + ÌÜ†Ïä§" },
        { id: 3, label: "Ï†ÄÍ∑∏ + ÌÖåÎûÄ" }, { id: 4, label: "Ï†ÄÍ∑∏ + ÎûúÎç§" },
        { id: 5, label: "ÌÜ†Ïä§ + ÌÜ†Ïä§" }, { id: 6, label: "ÌÜ†Ïä§ + ÌÖåÎûÄ" },
        { id: 7, label: "ÌÜ†Ïä§ + ÎûúÎç§" }, { id: 8, label: "ÌÖåÎûÄ + ÌÖåÎûÄ" },
        { id: 9, label: "ÌÖåÎûÄ + ÎûúÎç§" }, { id: 10, label: "ÎûúÎç§ + ÎûúÎç§" }
    ];

    let myTeam, myRole, myId = Math.random().toString(36).substr(2, 9);
    const createInitialState = () => ({
        round: 1,
        aUsed: [],
        bUsed: [],
        aPick: null,
        bPick: null,
        aDone: false,
        bDone: false,
        history: [],
        awaitingResult: false,
        pendingMatch: null
    });

    function normalizeGameState(state) {
        const safeState = state || {};
        return {
            round: safeState.round || 1,
            aUsed: Array.isArray(safeState.aUsed) ? safeState.aUsed : [],
            bUsed: Array.isArray(safeState.bUsed) ? safeState.bUsed : [],
            aPick: safeState.aPick || null,
            bPick: safeState.bPick || null,
            aDone: !!safeState.aDone,
            bDone: !!safeState.bDone,
            history: Array.isArray(safeState.history) ? safeState.history : [],
            awaitingResult: !!safeState.awaitingResult,
            pendingMatch: safeState.pendingMatch || null
        };
    }

    let gameState = createInitialState();

    db.ref('presence').on('value', snap => {
        const pres = snap.val() || {};
        ['A-Selector', 'B-Selector', 'A-Viewer', 'B-Viewer'].forEach(key => {
            const card = document.getElementById('card-' + key);
            const tag = document.getElementById('tag-' + key);
            if (card && tag) {
                if (pres[key]) { 
                    card.classList.add('locked'); 
                    tag.innerHTML = 'Ï†êÏú† Ï§ë';
                } else { 
                    card.classList.remove('locked'); 
                    tag.innerHTML = '<span class="dot"></span>Ï†ëÏÜç Í∞ÄÎä•';
                }
            }
        });
    });

    db.ref('gameState').on('value', snap => { if (snap.exists()) { gameState = normalizeGameState(snap.val()); updateUI(); } });

    function join(teamColor, role) {
        if (!ensureAuthReady()) return;
        myTeam = (teamColor === 'Blue') ? 'A' : 'B';
        myRole = role;
        const key = `${myTeam}-${role}`;
        db.ref('presence/' + key).set(myId).then(() => {
            db.ref('presence/' + key).onDisconnect().remove();
            document.getElementById('lobby').style.display = 'none';
            document.getElementById('main-container').style.display = 'block';
            document.getElementById('user-tag').innerText = `${teamColor} ${role}`;
            document.getElementById('user-tag').style.color = (teamColor === 'Blue') ? 'var(--blue-main)' : 'var(--red-main)';
            renderGrids();
        }).catch(showDbError);
    }

    function goHome() {
        if(confirm("Î°úÎπÑÎ°ú Ïù¥ÎèôÌïòÏãúÍ≤†ÏäµÎãàÍπå?")) {
            if (!ensureAuthReady()) return;
            const key = `${myTeam}-${myRole}`;
            db.ref('presence/' + key).remove().then(() => {
                location.reload();
            }).catch(showDbError);
        }
    }

    function renderGrids() {
        const grid = document.getElementById('main-race-grid'); grid.innerHTML = '';
        RACES.forEach(r => {
            const d = document.createElement('div'); d.className = 'race-item'; d.id = `race-${r.id}`; d.innerText = r.label;
            d.onclick = () => {
                if (myRole !== 'Selector') return;
                if (!ensureAuthReady()) return;
                const used = myTeam === 'A' ? (gameState.aUsed || []) : (gameState.bUsed || []);
                const done = myTeam === 'A' ? gameState.aDone : gameState.bDone;
                if (!used.includes(r.id) && !done && !gameState.awaitingResult && gameState.round <= 10) {
                    if (myTeam === 'A') gameState.aPick = r; else gameState.bPick = r;
                    db.ref('gameState').set(gameState).catch(showDbError);
                }
            };
            grid.appendChild(d);
        });
        const remList = document.getElementById('opp-rem-list'); remList.innerHTML = '';
        RACES.forEach(r => {
            const s = document.createElement('span'); s.className = 'rem-item'; s.id = `rem-${r.id}`; s.innerText = r.label; remList.appendChild(s);
        });
    }

    function confirmSelection() {
        if (!ensureAuthReady()) return;
        if (myRole !== 'Selector' || gameState.awaitingResult || gameState.round > 10) return;
        if (myTeam === 'A' && !gameState.aPick) return;
        if (myTeam === 'B' && !gameState.bPick) return;

        if (myTeam === 'A') gameState.aDone = true; else gameState.bDone = true;
        if (gameState.aDone && gameState.bDone) {
            if (!gameState.aPick || !gameState.bPick) return;
            gameState.awaitingResult = true;
            gameState.pendingMatch = { r: gameState.round, a: gameState.aPick, b: gameState.bPick };
        }
        db.ref('gameState').set(gameState).catch(showDbError);
    }

    function submitRoundResult(myResult) {
        if (!ensureAuthReady()) return;
        if (myRole !== 'Selector' || !gameState.awaitingResult || !gameState.pendingMatch) return;
        if (myResult !== 'W' && myResult !== 'L') return;

        if (!gameState.history) gameState.history = [];
        if (!gameState.aUsed) gameState.aUsed = [];
        if (!gameState.bUsed) gameState.bUsed = [];

        const winner = myResult === 'W' ? myTeam : (myTeam === 'A' ? 'B' : 'A');
        const aResult = winner === 'A' ? 'W' : 'L';
        const bResult = winner === 'B' ? 'W' : 'L';
        const roundNo = gameState.pendingMatch.r || gameState.round;

        // Prevent duplicate write for same round in the same client state.
        if (gameState.history.some(h => h.r === roundNo)) return;

        const roundHistory = {
            r: roundNo,
            a: gameState.pendingMatch.a,
            b: gameState.pendingMatch.b,
            winner,
            aResult,
            bResult
        };
        gameState.history.push(roundHistory);

        if (roundHistory.a && roundHistory.a.id && !gameState.aUsed.includes(roundHistory.a.id)) gameState.aUsed.push(roundHistory.a.id);
        if (roundHistory.b && roundHistory.b.id && !gameState.bUsed.includes(roundHistory.b.id)) gameState.bUsed.push(roundHistory.b.id);

        gameState.round++;
        gameState.aDone = false;
        gameState.bDone = false;
        gameState.aPick = null;
        gameState.bPick = null;
        gameState.awaitingResult = false;
        gameState.pendingMatch = null;

        db.ref('gameState').set(gameState).catch(showDbError);
    }

    function handleReset(isForce) {
        if (confirm(isForce ? "ÏãúÏä§ÌÖúÏùÑ Í∞ïÏ†ú Ï¥àÍ∏∞ÌôîÌï†ÍπåÏöî?" : "Îç∞Ïù¥ÌÑ∞Î•º Ï¥àÍ∏∞ÌôîÌï†ÍπåÏöî?")) {
            if (!ensureAuthReady()) return;
            db.ref('gameState').set(createInitialState()).then(() => {
                if (isForce) db.ref('presence').remove().then(() => { location.reload(); }).catch(showDbError);
            }).catch(showDbError);
        }
    }

    function updateUI() {
        document.getElementById('round-title').innerText = gameState.round > 10 ? "Draft Ended" : `ROUND ${gameState.round} / 10`;
        const myDone = myTeam === 'A' ? gameState.aDone : gameState.bDone;
        const myPick = myTeam === 'A' ? gameState.aPick : gameState.bPick;
        const oppDone = myTeam === 'A' ? gameState.bDone : gameState.aDone;
        document.getElementById('ui-pick-my').innerText = myPick ? myPick.label : "-";
        document.getElementById('ui-pick-opp').innerText = gameState.awaitingResult ? "Result pending..." : (oppDone ? "Ready" : "Selecting...");
        
        const myUsed = myTeam === 'A' ? (gameState.aUsed || []) : (gameState.bUsed || []);
        const oppUsed = myTeam === 'A' ? (gameState.bUsed || []) : (gameState.aUsed || []);

        RACES.forEach(r => {
            const el = document.getElementById(`race-${r.id}`);
            if (el) {
                el.className = 'race-item';
                if (myUsed.includes(r.id)) el.classList.add('used');
                if (myPick && myPick.id === r.id) el.classList.add('selected');
            }
            const rel = document.getElementById(`rem-${r.id}`);
            if (rel) rel.className = oppUsed.includes(r.id) ? 'rem-item used' : 'rem-item';
        });

        document.getElementById('btn-confirm').disabled = (myRole !== 'Selector' || !myPick || myDone || gameState.round > 10 || gameState.awaitingResult);
        
        const resultPanel = document.getElementById('result-panel');
        const resultHint = document.getElementById('result-hint');
        const btnResultWin = document.getElementById('btn-result-win');
        const btnResultLose = document.getElementById('btn-result-lose');
        if (resultPanel && resultHint && btnResultWin && btnResultLose) {
            const canSubmitResult = (myRole === 'Selector' && gameState.awaitingResult && gameState.round <= 10);
            resultPanel.style.display = gameState.awaitingResult ? 'block' : 'none';
            resultHint.innerText = canSubmitResult ? `Round ${gameState.round}: choose win/loss for your team.` : `Round ${gameState.round}: waiting for selector result input.`;
            btnResultWin.disabled = !canSubmitResult;
            btnResultLose.disabled = !canSubmitResult;
        }
        
        const tbody = document.getElementById('history-body'); tbody.innerHTML = '';
        if (gameState.history) {
            const sortedHistory = gameState.history.slice().reverse();
            sortedHistory.forEach((h, index) => {
                const rowClass = index === 0 ? 'class="latest-row"' : '';
                const aLabel = h.a && h.a.label ? h.a.label : '-';
                const bLabel = h.b && h.b.label ? h.b.label : '-';
                const aResult = h.aResult || '-';
                const bResult = h.bResult || '-';
                const aBadgeClass = aResult === 'W' ? 'result-badge win' : (aResult === 'L' ? 'result-badge lose' : 'result-badge');
                const bBadgeClass = bResult === 'W' ? 'result-badge win' : (bResult === 'L' ? 'result-badge lose' : 'result-badge');
                tbody.innerHTML += `<tr ${rowClass}><td>${h.r}</td><td style="color:var(--blue-main)"><div class="history-pick">${aLabel}</div><span class="${aBadgeClass}">${aResult}</span></td><td style="color:var(--red-main)"><div class="history-pick">${bLabel}</div><span class="${bBadgeClass}">${bResult}</span></td></tr>`;
            });
        }

        const scoreSummary = document.getElementById('score-summary');
        const scoreBlue = document.getElementById('score-blue');
        const scoreRed = document.getElementById('score-red');
        if (scoreSummary && scoreBlue && scoreRed) {
            let blueWins = 0;
            let redWins = 0;
            (gameState.history || []).forEach(h => {
                if (h.winner === 'A' || h.aResult === 'W') blueWins++;
                if (h.winner === 'B' || h.bResult === 'W') redWins++;
            });
            const played = (gameState.history || []).length;
            scoreBlue.innerText = String(blueWins);
            scoreRed.innerText = String(redWins);
            scoreSummary.innerText = gameState.awaitingResult ? `Result pending for Round ${gameState.round}  |  Played ${played} / 10` : `Played ${played} / 10`;
        }
    }
</script>
</body>
</html>
